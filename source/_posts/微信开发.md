---
title: 微信开发
date: 2018-05-22 09:55:40
tags:
---

# 简介

## 微信公众平台

[微信公众平台](https://mp.weixin.qq.com/)是运营者通过公众号为微信用户提供资讯和服务的平台 。公众号是以微信用户的一个联系人形式存在的。

微信公众号类型：

- 订阅号：为用户提供信息订阅，类似报纸杂志，每天可群发1条消息。适用人群：个人、媒体、企业、政府或其他组织。
- 服务号：为用户提供服务交互，每月可群发4条消息。适用人群：媒体、企业、政府或其他组织。
- 企业微信（原企业号）：用公司内部办公（OA），需要验证用户为企业身份后才可关注。
- 小程序（应用号）：是运行在微信之上的应用，是订阅号和服务号的扩展。适用人群：个人、媒体、企业、政府或其他组织。

## 微信开放平台

[微信开放平台](https://open.weixin.qq.com/)是微信为第三方应用程序提供接口，允许第三方应用支持微信分享、微信支付、微信扫码登录等能力。

## 微信支付

[微信支付](https://pay.weixin.qq.com)

## 表情开放平台

[微信表情开放平台](https://sticker.weixin.qq.com)

## 微信广告

[微信广告](https://e.qq.com)

为了识别用户，每个用户针对每个公众号会产生一个安全的OpenID（用户微信号加密后的结果 ），如果需要在多公众号、移动应用之间做用户共通，则需前往微信开放平台，将这些公众号和应用绑定到一个开放平台账号下。绑定后，一个用户虽然对多个公众号和应用有多个不同的OpenID，但他对所有这些同一开放平台账号下的公众号和应用，只有一个UnionID。可通过获取用户基本信息中的UnionID来区分用户的唯一性。

<!--more-->

# 准备

1. 申请一个域名（需要ICP备案）；
2. 申请SSL证书。

# 微信开发

## 工具

### 测试号

在申请到认证公众号之前，你可以先通过[申请测试号](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login)来直接体验和测试公众平台所有高级接口。

### Web开发工具

在微信公众平台的“开发者工具”中有一个Web开发工具，可在PC或Mac上模拟访问微信内网页，帮助开发者更方便地进行开发和调试。

### 在线接口调试工具

[在线接口调试工具](https://mp.weixin.qq.com/debug/)可以帮助开发者检测微信公众平台开发者API的请求参数和响应结果。

### 内网穿透工具

[natapp](https://natapp.cn/)

## 框架

[WxJava](https://github.com/Wechat-Group/WxJava)：微信Java开发工具包，支持包括微信支付、开放平台、小程序、企业号和公众号等的开发。

# 申请公众号

申请地址：<https://mp.weixin.qq.com>

> 通过“支付验证注册”的公众号是未认证的账号，只有通过“微信认证”的账号才是认证账户。微信认证费是300元。

# 内容管理

## 内容管理模式

公众平台编辑模式和开发者模式可以随时互相切换，切换后原保存内容不会丢失。

### 编辑模式

成功注册公众号后，公众平台的内容管理默认是编辑模式。这时，可以使用微信公众平台官方提供的功能管理内容。并且微信推送给公众号的消息或事件，也是推送给微信公众平台官方的内容管理平台。

### 开发者模式

为了在自己的服务器上接收微信推送的消息或事件，必需启用开发者模式。

启用开发者模式后，微信公众平台官方提供的内容管理功能将不可用。但原通过官方内容管理做的设置（例如增加的自定义菜单等）仍然是有效的。

#### 开启开发者模式

登录微信公众平台官网后，在公众平台官网的`开发-基本设置`页面，勾选协议成为开发者，点击“修改配置”按钮，填写服务器地址（URL）、Token和EncodingAESKey，其中URL是开发者用来接收微信消息和事件的接口URL。Token可由开发者可以任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性）。EncodingAESKey由开发者手动填写或随机生成，将用作消息体加解密密钥。

同时，开发者可选择消息加解密方式：明文模式、兼容模式和安全模式。

#### 接入微信公众平台

开发者提交信息后，微信服务器将发送`GET`请求到填写的服务器地址URL上。开发者通过检验`signature`对请求进行校验（下面有校验方式）。若确认此次GET请求来自微信服务器，请原样返回`echostr`参数内容，则接入生效，成为开发者；否则接入失败。 

在没有接入微信公众平台时，微信公众平台推送的消息和事件（例如用户向**关注的**公众号上发送的消息）是直接转发到公众平台官方的内容管理平台中。接入微信公众平台后，微信公众平台推送的消息和事件就会转发（`POST`请求）给第三方服务器。第三方开发者可以接收、处理和回复微信发送的消息。

#### 接收微信推送消息

参见“消息管理”。

在将你的服务器接入到微信平台的时候，以及每次微信推送消息给你的服务器的时候，你都应该按照微信的要求对推送过来的消息进行校验，确保这些消息是从微信平台发送过来的。 

微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次。假如服务器无法保证在五秒内处理并回复，可以直接回复空串，微信服务器不会对此作任何处理，并且不会发起重试。

## 公众平台接口调用

既可以在开发者模式下调用公众平台接口，也可以在编辑模式下调用。

微信公众号接口必须以`http://`或`https://`开头，分别支持80端口和443端口。

### 获取接口调用凭证——access_token

公众平台以access_token为接口调用凭据，来调用接口，所有接口的调用需要先获取access_token，access_token在2小时内有效，过期需要重新获取，但1天内获取次数有限，开发者需自行存储。
<https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET>

### 调用公众平台接口

每个接口都有每日接口调用频次限制。

## 菜单管理

### 自定义菜单

自定义菜单最多包括3个一级菜单，每个一级菜单最多包含5个二级菜单。

一级菜单最多4个汉字（16个字节）；二级菜单最多7个汉字，多出来的部分将会以“...”代替，不超过60个字节。

### 自定义菜单类型

1. click：点击推事件用户点击click类型按钮后，微信服务器会通过消息接口推送消息类型为event的结构给开发者（参考消息接口指南），并且带上按钮中开发者填写的key值，开发者可以通过自定义的key值与用户进行交互；
2. view：跳转URL用户点击view类型按钮后，微信客户端将会打开开发者在按钮中填写的网页URL，可与网页授权获取用户基本信息接口结合，获得用户基本信息。
3. scancode_push：扫码推事件用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后显示扫描结果（如果是URL，将进入URL），且会将扫码的结果传给开发者，开发者可以下发消息。
4. scancode_waitmsg：扫码推事件且弹出“消息接收中”提示框用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后，将扫码的结果传给开发者，同时收起扫一扫工具，然后弹出“消息接收中”提示框，随后可能会收到开发者下发的消息。
5. pic_sysphoto：弹出系统拍照发图用户点击按钮后，微信客户端将调起系统相机，完成拍照操作后，会将拍摄的相片发送给开发者，并推送事件给开发者，同时收起系统相机，随后可能会收到开发者下发的消息。
6. pic_photo_or_album：弹出拍照或者相册发图用户点击按钮后，微信客户端将弹出选择器供用户选择“拍照”或者“从手机相册选择”。用户选择后即走其他两种流程。
7. pic_weixin：弹出微信相册发图器用户点击按钮后，微信客户端将调起微信相册，完成选择操作后，将选择的相片发送给开发者的服务器，并推送事件给开发者，同时收起相册，随后可能会收到开发者下发的消息。
8. location_select：弹出地理位置选择器用户点击按钮后，微信客户端将调起地理位置选择工具，完成选择操作后，将选择的地理位置发送给开发者的服务器，同时收起位置选择工具，随后可能会收到开发者下发的消息。
9. media_id：下发消息（除文本消息）用户点击media_id类型按钮后，微信服务器会将开发者填写的永久素材id对应的素材下发给用户，永久素材类型可以是图片、音频、视频、图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。
10. view_limited：跳转图文消息URL用户点击view_limited类型按钮后，微信客户端将打开开发者在按钮中填写的永久素材id对应的图文消息URL，永久素材类型只支持图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。

#### 创建菜单

POST  https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN 

创建自定义菜单后，菜单的刷新策略是，在用户进入公众号会话页或公众号profile页时，如果发现上一次拉取菜单的请求在5分钟以前，就会拉取一下菜单，如果菜单有更新，就会刷新客户端的菜单。测试时可以尝试取消关注公众账号后再次关注，则可以看到创建后的效果。

#### 查询菜单

GET https://api.weixin.qq.com/cgi-bin/menu/get?access_token=ACCESS_TOKEN

#### 删除菜单

GET https://api.weixin.qq.com/cgi-bin/menu/delete?access_token=ACCESS_TOKEN

### 个性化菜单

微信公众平台新增了个性化菜单接口，开发者可以通过该接口，让公众号的不同用户群体看到不一样的自定义菜单。该接口开放给已认证订阅号和已认证服务号。

#### 创建个性化菜单

POST https://api.weixin.qq.com/cgi-bin/menu/addconditional?access_token=ACCESS_TOKEN

## 消息管理

### 消息服务类型

- 群发消息：公众号可以以一定频次（订阅号为每天1次，服务号为每月4次），向用户群发消息，包括文字消息、图文消息、图片、视频、语音等。
- 被动回复消息：在用户给公众号发消息后，微信服务器会将消息发到开发者预先在开发者中心设置的服务器地址（开发者需要进行消息真实性验证），公众号可以在5秒内做出回复，可以回复一个消息，也可以回复命令告诉微信服务器这条消息暂不回复（假如服务器无法保证在五秒内处理回复，则必须回复“success”或者“”（空串），否则微信后台会发起三次重试。）。被动回复消息可以设置加密（在公众平台官网的开发者中心处设置，设置后，按照消息加解密文档来进行处理。其他3种消息的调用因为是API调用而不是对请求的返回，所以不需要加解密）。
- 客服消息：在用户给公众号发消息后的48小时内，公众号可以给用户发送不限数量的消息，主要用于客服场景。用户的行为会触发事件推送，某些事件推送是支持公众号据此发送客服消息的，详见微信推送消息与事件说明文档。
- 模板消息：在需要对用户发送服务通知（如刷卡提醒、服务预约成功通知等）时，公众号可以用特定内容模板，主动向用户发送消息。

### 接收普通消息

### 接收事件推送

### 被动回复消息

被动回复消息不是一个独立接口，它实际上是对接收到的消息的响应。

### 消息加解密

### 客服消息

当用户和公众号产生特定动作的交互时，微信将会把消息数据推送给开发者，开发者可以在一段时间内（目前修改为48小时）调用客服接口，通过`POST`一个JSON数据包来发送消息给普通用户。 

#### 客服账号管理

> 请注意，必须先在公众平台官网为公众号设置微信号后才能使用该能力。 

#### 发客服消息

POST https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=ACCESS_TOKEN

#### 客服输入状态

开发者可通过调用“客服输入状态”接口，返回客服当前输入状态给用户：

POST https://api.weixin.qq.com/cgi-bin/message/custom/typing?access_token=ACCESS_TOKEN

### 群发消息

在公众平台上，为订阅号提供了每天一条的群发权限，为服务号提供每月（自然月）4条的群发权限。 

### 模板消息

模板消息仅用于公众号向用户发送重要的服务通知，只能用于符合其要求的服务场景中，如信用卡刷卡通知，商品购买成功通知等。不支持广告等营销类消息以及其它所有可能对用户造成骚扰的消息。 

## 素材管理

## 留言管理

## 用户管理

# 微信网页开发

## 配置网页授权回调域名

在微信公众号请求用户网页授权之前，开发者需要先到公众平台官网中的“开发 - 接口权限 - 网页服务 - 网页帐号 - 网页授权获取用户基本信息”的配置选项中，修改授权回调域名。请注意，这里填写的是域名（是一个字符串），而不是URL，因此请勿加 `http://` 等协议头。

授权回调域名配置规范为全域名，比如需要网页授权的域名为：www.qq.com，配置以后此域名下面的页面<http://www.qq.com/music.html> 、 <http://www.qq.com/login.html> 都可以进行OAuth2.0鉴权。但[http://pay.qq.com](http://pay.qq.com/) 、 [http://music.qq.com](http://music.qq.com/) 、 [http://qq.com无法进行OAuth2.0鉴权](http://qq.xn--comoauth2-735sh62dwk9eysua.xn--0-k76bu98j/)。

## 微信网页授权

如果用户在微信客户端中访问第三方网页或服务时，通过微信网页授权机制，第三方可以获得用户的基本信息，进而实现业务逻辑（例如，通过获取用户的openid来实现自动注册或登录功能）。

如果第三方不需要获取微信用户信息，则不需要经过微信网页授权。这时，可完全由第三方自己管理登录、注册等功能。

1. 引导用户（例如通过菜单）进入第三方开发的授权页面。如果URL中有`openid`查询参数，则将它设置进cookie。如果cookie中没有`openid`，则继续。

2. 重定向到后端服务，后端请求微信授权，以获取code：https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect

   当`scope`是`snsapi_userinfo`时，还会弹出授权页，让用户授权。而`scope`是`snsapi_base`时，不会弹出授权页面，直接跳转，只能获取用户openid。

3. 重定向到另一个后端服务`REDIRECT_URI/?code=CODE&state=STATE`

4. 后端通过code换取网页授权access_token（专用于网页授权，与公众平台接口调用凭证的access_token不同）：https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code
   得到access_token、refresh_token和用户的openid。

5. 如果数据库中没有这个openid的用户记录，则获取用户信息（包含unionid，可选）：https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&openid=OPENID&lang=zh_CN
   并保存进数据库。

   > 获取用户的OpenID是无需用户同意的，获取用户的基本信息则需用户同意。因此，要获取用户基本信息，则`scope`必须是`snsapi_userinfo`。

6. 重定向回**1**中的网页（带`openid`查询参数）。

由于access_token拥有较短的有效期（通常是2小时），当access_token超时后，可以使用refresh_token进行刷新，refresh_token有效期为30天，当refresh_token失效之后，需要用户重新授权。 刷新access_token：

GET https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=APPID&grant_type=refresh_token&refresh_token=REFRESH_TOKEN

## 微信JS-SDK

微信JS-SDK是开发者在网页上通过JavaScript代码使用微信原生功能的工具包，开发者可以使用它在网页上录制和播放微信语音、监听微信分享、上传手机本地图片、拍照、位置等许多能力。同时可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力。

### 应用步骤

#### 步骤一：绑定域名

先登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。

#### 步骤二：引入JS文件

在需要调用JS接口的页面引入如下JS文件，（支持https）：<http://res.wx.qq.com/open/js/jweixin-1.2.0.js>

备注：支持使用 AMD/CMD 标准模块加载方法加载。

#### 步骤三：通过config接口注入权限验证配置

所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用（同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用,目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。

```
wx.config({
    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
    appId: '', // 必填，公众号的唯一标识
    timestamp: , // 必填，生成签名的时间戳
    nonceStr: '', // 必填，生成签名的随机串
    signature: '',// 必填，签名
    jsApiList: [] // 必填，需要使用的JS接口列表
});
```

参与生成签名（signature）的字段包括noncestr（随机字符串）、有效的jsapi_ticket、timestamp（时间戳）、url（当前网页的URL、不包含`#`及其后面部分） 。

示例：

```
noncestr=Wm3WZYTPz0wzccnW
jsapi_ticket=sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3-Sl-HhTdfl2fzFy1AOcHKP7qg
timestamp=1414587457
url=http://mp.weixin.qq.com?params=value
```

jsapi_ticket是公众号用于调用微信JS接口的临时票据。正常情况下，jsapi_ticket的有效期为7200秒，通过access_token来获取。由于获取jsapi_ticket的api调用次数非常有限，频繁刷新jsapi_ticket会导致api调用受限，影响自身业务，开发者必须在自己的服务全局缓存jsapi_ticket 。 采用http GET方式请求获得jsapi_ticket：

GET <https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&type=jsapi> 

成功返回如下JSON：

```
{
"errcode":0,
"errmsg":"ok",
"ticket":"sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3-Sl-HhTdfl2fzFy1AOcHKP7qg",
"expires_in":7200
}
```

对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&key2=value2…）拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。字段名和字段值都采用原始值，不进行URL 转义。

```
jsapi_ticket=sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3-Sl-HhTdfl2fzFy1AOcHKP7qg&noncestr=Wm3WZYTPz0wzccnW×tamp=1414587457&url=http://mp.weixin.qq.com?params=value
```

对string1作sha1加密，得到signature： 

```
0f9de62fce790f9a083d5c99e95740ceb90c27ed
```

注意事项

1. 签名用的noncestr和timestamp必须与wx.config中的nonceStr和timestamp相同。
2. 签名用的url必须是调用JS接口页面的完整URL。
3. 出于安全考虑，开发者必须在服务器端实现签名的逻辑。

JS接口列表（版本1.0.0）：

- onMenuShareTimeline
- onMenuShareAppMessage
- onMenuShareQQ
- onMenuShareWeibo
- onMenuShareQZone
- startRecord
- stopRecord
- onVoiceRecordEnd
- playVoice
- pauseVoice
- stopVoice
- onVoicePlayEnd
- uploadVoice
- downloadVoice
- chooseImage
- previewImage
- uploadImage
- downloadImage
- translateVoice
- getNetworkType
- openLocation
- getLocation
- hideOptionMenu
- showOptionMenu
- hideMenuItems
- showMenuItems
- hideAllNonBaseMenuItem
- showAllNonBaseMenuItem
- closeWindow
- scanQRCode
- chooseWXPay
- openProductSpecificView
- addCard
- chooseCard
- openCard

#### 步骤四：通过ready接口处理成功验证

```
wx.ready(function(){
    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
});
```

#### 步骤五：通过error接口处理失败验证

```
wx.error(function(res){
    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
});
```

### 接口调用说明

所有接口通过wx对象(也可使用jWeixin对象)来调用，参数是一个对象，除了每个接口本身需要传的参数之外，还有以下通用参数：

1. success：接口调用成功时执行的回调函数。
2. fail：接口调用失败时执行的回调函数。
3. complete：接口调用完成时执行的回调函数，无论成功或失败都会执行。
4. cancel：用户点击取消时的回调函数，仅部分有用户取消操作的api才会用到。
5. trigger: 监听Menu中的按钮点击时触发的方法，该方法仅支持Menu中的相关接口。

备注：不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回。

以上几个函数都带有一个参数，类型为对象，其中除了每个接口本身返回的数据之外，还有一个通用属性errMsg，其值格式如下：

- 调用成功时："xxx:ok" ，其中xxx为调用的接口名。
- 用户取消时："xxx:cancel"，其中xxx为调用的接口名。
- 调用失败时：其值为具体错误信息。

### 基础接口

判断当前客户端版本是否支持指定JS接口。

```
wx.checkJsApi({
    jsApiList: ['chooseImage'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
    success: function(res) {
    // 以键值对的形式返回，可用的api值true，不可用为false
    // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
    }
});
```

备注：checkJsApi接口是客户端6.0.2新引入的一个预留接口，第一期开放的接口均可不使用checkJsApi来检测。

### 分享接口

### 图像接口

### 音频接口

### 智能接口

### 设备信息接口

### 地理位置接口

### 摇一摇周边接口

### 界面操作接口

### 扫一扫接口

### 微信小店接口

### 微信卡券接口

### 微信支付接口

发起一个微信支付请求：

```javascript
wx.chooseWXPay({
  timestamp: 0, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
  nonceStr: '', // 支付签名随机串，不长于 32 位
  package: '', // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
  signType: '', // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
  paySign: '', // 支付签名
  success: function (res) {
  	// 支付成功后的回调函数
  }
});
```

备注：prepay_id 通过微信支付统一下单接口拿到，paySign 采用统一的微信支付 Sign 签名生成方法，注意这里 appId 也要参与签名，appId 与 config 中传入的 appId 一致，即最后参与签名的参数有appId、timeStamp、nonceStr、package、signType。

### 共享收货地址接口

# 微信支付

订阅号不可申请微信支付，服务号通过认证后才可申请微信支付。

## 支付模式

公众号支付：公众号支付是用户在微信中打开商户的H5页面，商户在H5页面通过调用微信支付提供的JSAPI接口调起微信支付模块完成支付。 应用场景有：

- 用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付
- 用户的好友在朋友圈、聊天窗口等分享商家页面连接，用户点击链接打开商家页面，完成支付
- 将商户页面转换成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付

APP支付：APP支付又称移动端支付，是商户通过在移动端应用APP中集成开放SDK调起微信支付模块完成支付的模式。 

扫码支付：扫码支付是商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。一个二维码只能对应一个金额。

刷卡支付：刷卡支付是用户展示微信钱包内的“刷卡条码/二维码”给商户系统扫描后直接完成支付的模式。主要应用线下面对面收银的场景。 （用户无需输入金额）

微信买单：无需开发。分为收款码收款（用户扫商户二维码，用户需输入金额）和扫码收款（商户扫用户二维码，商户需输入金额）。

H5支付：用户在微信以外的手机浏览器请求微信支付。

小程序支付

## 接入流程

第一步：注册公众号（类型须为：服务号、政府或媒体订阅号、企业号）

请根据营业执照类型选择以下主体注册：[个体工商户](http://kf.qq.com/faq/120911VrYVrA151009JB3i2Q.html)| [企业/公司](http://kf.qq.com/faq/120911VrYVrA151013MfYvYV.html)| [政府](http://kf.qq.com/faq/120911VrYVrA15100973ABZz.html)| [媒体](http://kf.qq.com/faq/120911VrYVrA151013aMNfeQ.html)| [其他类型](http://kf.qq.com/faq/120911VrYVrA151013nYFZ7Z.html)。

第二步：认证公众号

公众号认证后才可申请微信支付，认证费：300元/次，[查看认证流程](http://kf.qq.com/product/weixinmp.html#hid=97)。

第三步：提交资料申请微信支付

登录公众平台，点击左侧菜单【微信支付】，开始填写资料等待审核，审核时间为48小时内。

第四步：开户成功，进行账户验证

资料审核通过后，开户信息会通过邮件、公众号发送给联系人，请按照指引填写财付通备付金汇入的随机金额，完成账户验证。（[查看验证方法](http://kf.qq.com/faq/180424beENJZ180424qUzuuI.html)）

第五步：在线签署协议

本协议为线上电子协议，签署后方可进行交易及资金结算，签署完立即生效。[点此提前预览协议](https://pay.weixin.qq.com/index.php/public/apply_sign/protocol)内容。

第六步：启动设计和开发

支付接口已获得，可根据[开发文档](https://pay.weixin.qq.com/wiki/doc/api/index.html)进行开发。

## 公众号支付

### 设置支付目录

在[微信商户平台](https://pay.weixin.qq.com)设置您的公众号支付支付目录，设置路径：商户平台-->产品中心-->开发配置。公众号支付在请求支付的时候会校验请求来源是否有在商户平台做了配置，所以必须确保支付目录已经正确的被配置，否则将验证失败，请求支付不成功。

### 支付流程

![公众号支付流程](微信公众平台/公众号支付流程.png)

# 微信门店

# 微信卡券

## 开通卡券功能

## 创建卡券

| 参数名  | 描述                                                         |
| ------- | ------------------------------------------------------------ |
| card_id | 卡券ID。一个卡券ID对应一类卡券，包含了相应库存数量的Code码。 |
| code    | 卡券Code码。一张卡券的唯一标识，核销卡券时使用此串码。       |

### 上传卡券logo

请求地址：

POST/FROM  https://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token=ACCESS_TOKEN&type=image 

请求参数：

- buffer：必需，文件流。

正确响应：

```json
{
  "url":"http://mmbiz.qpic.cn/mmbiz/iaL1LJM1mF9aRKPZJkmG8xXhiaHqkKSVMMWeN3hLut7X7hicFNjakmxibMLGWpXrEXB33367o7zHN0CwngnQY7zb7g/0"
}
```

错误响应：

```json
{"errcode":40009, "errmsg":"invalid image size"}
```

### 创建卡券

请求地址：

POST  https://api.weixin.qq.com/card/create?access_token=ACCESS_TOKEN

请求体数据：

```json
{
  "card": {
    "card_type": "GROUPON",
    "groupon": {
      "base_info": {
        "logo_url": "http://mmbiz.qpic.cn/mmbiz/iaL1LJM1mF9aRKPZJkmG8xXhiaHqkKSVMMWeN3hLut7X7hicFNjakmxibMLGWpXrEXB33367o7zHN0CwngnQY7zb7g/0",
        "brand_name": "微信餐厅",
        "code_type": "CODE_TYPE_TEXT",
        "title": "132元双人火锅套餐",
        "color": "Color010",
        "notice": "使用时向服务员出示此券",
        "service_phone": "020-88888888",
        "description": "不可与其他优惠同享\n如需团购券发票，请在消费时向商户提出\n店内均可使用，仅限堂食",
        "date_info": {
          "type": "DATE_TYPE_FIX_TIME_RANGE",
          "begin_timestamp": 1397577600,
          "end_timestamp": 1472724261
        },
        "sku": {
          "quantity": 500000
        },
        "use_limit":100,
        "get_limit": 3,
        "use_custom_code": false,
        "bind_openid": false,
        "can_share": true,
        "can_give_friend": true,
        "location_id_list": [
          123,
          12321,
          345345
        ],
        "center_title": "顶部居中按钮",
        "center_sub_title": "按钮下方的wording",
        "center_url": "www.qq.com",
        "custom_url_name": "立即使用",
        "custom_url": "http://www.qq.com",
        "custom_url_sub_title": "6个汉字tips",
        "promotion_url_name": "更多优惠",
        "promotion_url": "http://www.qq.com",
        "source": "大众点评"
      },
      "advanced_info": {
        "use_condition": {
          "accept_category": "鞋类",
          "reject_category": "阿迪达斯",
          "can_use_with_other_discount": true
        },
        "abstract": {
          "abstract": "微信餐厅推出多种新季菜品，期待您的光临",
          "icon_url_list": [
            "http://mmbiz.qpic.cn/mmbiz/p98FjXy8LacgHxp3sJ3vn97bGLz0ib0Sfz1bjiaoOYA027iasqSG0sj
            piby4vce3AtaPu6cIhBHkt6IjlkY9YnDsfw/0"
          ]
        },
        "text_image_list": [
          {
            "image_url": "http://mmbiz.qpic.cn/mmbiz/p98FjXy8LacgHxp3sJ3vn97bGLz0ib0Sfz1bjiaoOYA027iasqSG0sjpiby4vce3AtaPu6cIhBHkt6IjlkY9YnDsfw/0",
            "text": "此菜品精选食材，以独特的烹饪方法，最大程度地刺激食 客的味蕾"
          },
          {
            "image_url": "http://mmbiz.qpic.cn/mmbiz/p98FjXy8LacgHxp3sJ3vn97bGLz0ib0Sfz1bjiaoOYA027iasqSG0sj piby4vce3AtaPu6cIhBHkt6IjlkY9YnDsfw/0",
            "text": "此菜品迎合大众口味，老少皆宜，营养均衡"
          }
        ],
        "time_limit": [
          {
            "type": "MONDAY",
            "begin_hour":0,
            "end_hour":10,
            "begin_minute":10,
            "end_minute":59
          },
          {
            "type": "HOLIDAY"
          }
        ],
        "business_service": [
          "BIZ_SERVICE_FREE_WIFI",
          "BIZ_SERVICE_WITH_PET",
          "BIZ_SERVICE_FREE_PARK",
          "BIZ_SERVICE_DELIVER"
        ]
      },
      "deal_detail": "以下锅底2选1（有菌王锅、麻辣锅、大骨锅、番茄锅、清补 凉锅、酸菜鱼锅可选）：\n大锅1份 12元\n小锅2份 16元 "
    }
  }}
```

字段示图：

![卡券示图](微信公众平台/卡券示图.jpg)



## 投放卡券

### 创建二维码

## 核销卡券

## 管理卡券